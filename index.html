<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Absensi Pro</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { 
      --primary: #4361ee; 
      --primary-dark: #3a0ca3;
      --accent: #4cc9f0;
      --bg-app: #f8fafc; 
      --surface: #ffffff; 
      --text-dark: #0f172a; 
    }
    
    body { background-color: #cbd5e1; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; min-height: 100vh; margin: 0; color: var(--text-dark); }
    
    /* CONTAINER UTAMA */
    .app-container { 
      width: 100%; max-width: 400px; background: var(--bg-app); min-height: 100vh; position: relative; overflow-x: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.15); 
    }
    
    /* --- STYLE KHUSUS LOGIN --- */
    .login-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      height: 320px;
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
      padding-bottom: 50px;
    }
    
    /* Hiasan Bulat (Blob) */
    .blob { position: absolute; border-radius: 50%; filter: blur(40px); opacity: 0.4; }
    .blob-1 { width: 150px; height: 150px; background: var(--accent); top: -20px; left: -20px; }
    .blob-2 { width: 100px; height: 100px; background: #fff; bottom: 20px; right: -20px; opacity: 0.2; }

    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      margin: -60px 25px 0 25px;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
    }

    .input-group-text { background: transparent; border-right: none; border-radius: 12px 0 0 12px; color: var(--primary); }
    .form-control-login { border-left: none; border-radius: 0 12px 12px 0; padding: 12px; font-size: 0.95rem; }
    .form-control-login:focus { box-shadow: none; border-color: #dee2e6; }
    .input-group:focus-within { box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); border-radius: 12px; }

    .login-footer {
      text-align: center;
      margin-top: 40px;
      color: #94a3b8;
      font-size: 0.8rem;
      padding-bottom: 20px;
    }
    .login-footer img { height: 20px; opacity: 0.5; margin-bottom: 5px; }

    /* --- STYLE DASHBOARD & LAINNYA --- */
    .header-compact { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 30px 20px 40px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; color: white; text-align: center; margin-bottom: 20px; }
    .card-glass { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #e2e8f0; }
    
    .btn-main { width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; border: none; transition: 0.2s; cursor: pointer; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(to right, var(--primary), #3f37c9); color: white; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-gold { background: #f59e0b; color: white; } 
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-item { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
    /* --- CSS USER LIST (TAMBAHAN BARU) --- */
    .user-item { 
        display: flex; 
        justify-content: space-between; /* Kunci: Kiri & Kanan kepisah */
        align-items: center; 
        padding: 15px; 
        border-bottom: 1px solid #f1f5f9; 
        background: white;
    }
    .user-info { 
    text-align: left; 
    flex: 1; /* Ini akan mendorong tombol ke paling kanan */
    padding-right: 10px; 
}
    .user-info div { font-size: 0.95rem; font-weight: 600; color: #334155; }
    .user-info small { color: #64748b; font-size: 0.8rem; display: block; }
    
    .user-actions { 
        display: flex; gap: 8px; /* Jarak antar tombol */
    }
    /* -------------------------------------- */

    /* MODAL */
    .modal-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 2000; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; background: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
    .modal-content-scroll { flex: 1; overflow-y: auto; padding: 20px; }

    /* TAB OWNER */
    .nav-tabs .nav-link { color: #64748b; font-size: 0.9rem; border:none; }
    .nav-tabs .nav-link.active { color: var(--primary); font-weight: 600; border-bottom: 3px solid var(--primary); background: transparent; }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    
    .form-control, .form-select { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; font-size: 0.9rem; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="hidden"><div class="spinner-border text-primary"></div><div class="mt-2 small fw-bold">Memproses...</div></div>

  <div class="app-container">
    
    <div id="loginPage" class="fade-in">
      
      <div class="login-header">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="mb-3 bg-white bg-opacity-20 p-3 rounded-circle">
            <i class="fas fa-fingerprint fa-4x text-white"></i>
        </div>
        <h3 class="fw-bold m-0">E-Absensi</h3>
        <p class="opacity-75 small">Sistem Manajemen Kehadiran</p>
      </div>
      
      <div class="login-card">
        <h5 class="fw-bold text-center mb-4" style="color:var(--primary-dark)">Login Akun</h5>
        <form id="formLogin">
          
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="text" id="username" class="form-control form-control-login" placeholder="Username" required>
          </div>

          <div class="input-group mb-4">
            <span class="input-group-text"><i class="fas fa-lock"></i></span>
            <input type="password" id="password" class="form-control form-control-login" placeholder="Password" required>
          </div>

          <button type="submit" class="btn-main btn-primary shadow">MASUK SEKARANG <i class="fas fa-arrow-right ms-2"></i></button>
        </form>
      </div>

      <div class="login-footer">
        <div>&copy; 2026 PT. Maju Bersama</div>
        <div class="mt-2">
            <a href="#" class="text-decoration-none text-muted me-2">Bantuan</a> &bull; 
            <a href="#" class="text-decoration-none text-muted ms-2">Versi 3.0</a>
        </div>
      </div>

    </div>

    <div id="dashboard" class="hidden fade-in">
      <div class="header-compact" style="text-align: left; padding-bottom: 50px;">
        <div class="d-flex justify-content-between align-items-center">
           <div><h5 id="userNama" class="fw-bold m-0 text-white">User</h5><small id="userKantor" class="badge bg-white text-primary mt-1 border-0">-</small></div>
           <button onclick="logout()" class="btn btn-sm btn-outline-light border-0"><i class="fas fa-sign-out-alt fa-lg"></i></button>
        </div>
      </div>

      <div style="padding: 0 20px; margin-top: -40px;">
        <div class="card-glass py-2 px-3 mb-3 d-flex align-items-center justify-content-between">
           <small class="text-muted fw-bold"><i class="fas fa-satellite-dish me-2"></i>GPS Status</small><small id="statusJarak" class="text-secondary" style="font-size: 0.75rem;">Mencari...</small>
        </div>
        <div id="infoStatus" class="card-glass text-center"><div class="spinner-border spinner-border-sm text-secondary"></div></div>

        <div id="areaOwner" class="hidden mb-3">
            <button onclick="bukaOwnerPanel()" class="btn-main btn-gold shadow-sm"><i class="fas fa-user-shield me-2"></i> PANEL OWNER & USER</button>
        </div>

        <div id="actionButtons">
          <button id="btnMasuk" onclick="cekAksiAbsen('Masuk')" class="btn-main btn-primary mb-3 hidden shadow-sm"><i class="fas fa-camera me-2"></i> ABSEN MASUK</button>
          <button id="btnPulang" onclick="cekAksiAbsen('Pulang')" class="btn-main mb-3 hidden shadow-sm" style="background:#ef4444; color:white;"><i class="fas fa-home me-2"></i> ABSEN PULANG</button>
          <div id="msgSelesai" class="alert alert-success text-center hidden small border-0 bg-success bg-opacity-10 text-success fw-bold">Absensi Selesai</div>
        </div>

        <div class="menu-grid">
          <div class="menu-item" onclick="bukaRiwayat()"><i class="fas fa-history fa-lg text-primary mb-2"></i><div class="small">Riwayat</div></div>
          <div class="menu-item" onclick="tampilFormIzin()"><i class="fas fa-file-medical fa-lg text-warning mb-2"></i><div class="small">Izin / Sakit</div></div>
        </div>
      </div>
    </div>

    <div id="modalOwner" class="modal-full hidden fade-in">
        <div class="modal-header"><h5 class="fw-bold m-0">Panel Owner</h5><button onclick="document.getElementById('modalOwner').classList.add('hidden')" class="btn-close"></button></div>
        <ul class="nav nav-tabs justify-content-center bg-white" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-approval">Approval</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rekap">Laporan</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users" onclick="loadUsers()">Kelola User</button></li>
        </ul>
        <div class="modal-content-scroll">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-approval"><div id="listApproval">Loading...</div></div>
                <div class="tab-pane fade" id="tab-rekap">
                    <div class="card-glass p-3 mb-3">
                        <select id="filterCabang" class="form-select mb-2"><option value="All">Semua Cabang</option></select>
                        <div class="row g-2">
                            <div class="col-6"><select id="filterBulan" class="form-select"><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select></div>
                            <div class="col-6"><select id="filterTahun" class="form-select"><option value="2025">2025</option><option value="2026">2026</option></select></div>
                        </div>
                        <button onclick="loadRekap()" class="btn-main btn-primary mt-2">Tampilkan</button>
                    </div>
                    <div id="hasilRekap"></div>
                </div>
                <div class="tab-pane fade" id="tab-users">
                    <button onclick="formUser('add')" class="btn-main btn-primary mb-3"><i class="fas fa-plus me-2"></i> Tambah User Baru</button>
                    <div id="listUsers" class="card-glass p-0"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalFormUser" class="modal-full hidden bg-white">
        <div class="modal-header"><h5 class="fw-bold m-0" id="titleFormUser">User</h5><button onclick="closeFormUser()" class="btn-close"></button></div>
        <div class="p-4">
            <input type="hidden" id="u_mode"><input type="hidden" id="u_old_user">
            <label class="small fw-bold">Username</label><input type="text" id="u_username" class="form-control">
            <label class="small fw-bold">Password</label><input type="text" id="u_password" class="form-control">
            <label class="small fw-bold">Nama Lengkap</label><input type="text" id="u_nama" class="form-control">
            <label class="small fw-bold">Role</label><select id="u_role" class="form-select"><option value="Staff">Staff</option><option value="Pimpinan">Pimpinan</option></select>
            <label class="small fw-bold">Kantor Tugas</label><select id="u_kantor" class="form-select"></select>
            <button onclick="simpanUser()" class="btn-main btn-primary mt-3">Simpan Data</button>
        </div>
    </div>

    <div id="modalKamera" class="modal-full hidden" style="background:black; justify-content:center;">
      <video id="video" autoplay playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; transform:scaleX(-1);"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div style="width:260px; height:350px; border:2px solid white; border-radius:130px; position:absolute; z-index:10; box-shadow:0 0 0 999px rgba(0,0,0,0.5);"></div>
      <div style="position:absolute; bottom:40px; text-align:center; z-index:20; width:100%;">
        <button id="btnJepret" onclick="jepretDanKirim()" class="btn btn-light rounded-circle p-3" disabled><i class="fas fa-camera fa-2x"></i></button>
        <div class="mt-3"><button onclick="tutupKamera()" class="btn btn-sm text-white">Batal</button></div>
      </div>
    </div>

    <div id="modalIzin" class="modal-full hidden">
      <div class="modal-header"><h5 class="fw-bold m-0">Form Izin</h5><button onclick="document.getElementById('modalIzin').classList.add('hidden')" class="btn-close"></button></div>
      <div class="modal-content-scroll">
          <label class="small fw-bold">Jenis</label>
          <select id="tipeIzin" class="form-select" onchange="cekTipeIzin()"><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Cuti">Cuti</option></select>
          <div id="boxBuktiSakit" class="card-glass p-3 mb-3 bg-warning bg-opacity-10 border-warning hidden">
             <label class="small fw-bold"><i class="fas fa-paperclip"></i> Upload Surat Dokter</label>
             <input type="file" id="fileSakit" class="form-control mt-2" accept="image/*">
          </div>
          <label class="small fw-bold">Alasan</label><textarea id="ketIzin" class="form-control" rows="3"></textarea>
          <button onclick="kirimIzin()" class="btn-main btn-primary">Kirim</button>
      </div>
    </div>

    <div id="modalRiwayat" class="modal-full hidden">
      <div class="modal-header"><h5 class="fw-bold m-0">Riwayat</h5><button onclick="document.getElementById('modalRiwayat').classList.add('hidden')" class="btn-close"></button></div>
      <div id="listRiwayat" class="modal-content-scroll">Loading...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // PASTE URL DEPLOYMENT DISINI
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-77D7BjT8VhJ0yWja5ijqNJPWiM0ETX6O92pDMw-mMgf1_Lz5DraIE4BtU8zZM-NS/exec"; 
    // ==========================================
    const DAFTAR_KANTOR = [
      { nama: "Cabang Aimas 1", lat: -0.9571588, lon: 131.3232882 },
      { nama: "Cabang Aimas 2", lat: -0.9785222, lon: 131.3044910 },
      { nama: "Cabang KM 12",   lat: -0.9018995, lon: 131.3246220 },
      { nama: "Cabang KM 13",   lat: -0.9066222, lon: 131.3264656 }
    ];
    const MAX_JARAK_METER = 30; 

    var userGlobal = {}, lokasiGlobal = "", jarakGlobal = 9999, targetLat=0, targetLon=0, gpsId=null;

    function initCombo() {
       let sel = document.getElementById('filterCabang'); let sel2 = document.getElementById('u_kantor');
       sel.innerHTML = '<option value="All">Semua Cabang</option>'; sel2.innerHTML = '';
       DAFTAR_KANTOR.forEach(k => {
          sel.innerHTML += `<option value="${k.nama}">${k.nama}</option>`;
          sel2.innerHTML += `<option value="${k.nama}">${k.nama}</option>`; 
       });
       sel2.innerHTML += `<option value="Kantor Pusat">Kantor Pusat</option>`;
    }
    initCombo();

    async function kirimKeServer(payload) {
      document.getElementById('loadingOverlay').classList.remove('hidden');
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        return await response.json();
      } catch (error) { alert("Error: "+error); return null; } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
    }

    // LOGIN
    // UPDATE LOGIN (Dengan SweetAlert)
    // UPDATE LOGIN (Versi Alert Lebih Kecil & Elegan)
    document.getElementById('formLogin').addEventListener('submit', async function(e){
      e.preventDefault();
      var res = await kirimKeServer({ action: 'login', username: document.getElementById('username').value, password: document.getElementById('password').value });
      
      if(res && res.status == 'sukses'){
        userGlobal = res.data;
        document.getElementById('userNama').innerText = userGlobal.nama;
        document.getElementById('userKantor').innerHTML = userGlobal.kantorTugas;
        var kantor = DAFTAR_KANTOR.find(k => k.nama === userGlobal.kantorTugas);
        if(kantor) { targetLat = kantor.lat; targetLon = kantor.lon; } else { targetLat=0; targetLon=0; }
        
        if(userGlobal.role === 'Pimpinan') document.getElementById('areaOwner').classList.remove('hidden');
        else document.getElementById('areaOwner').classList.add('hidden');

        setupTombol(res.absenInfo);
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        startGPS();
        
        // --- NOTIFIKASI KECIL (TOAST) ---
        const Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        });

        Toast.fire({
          icon: 'success',
          title: 'Halo ' + userGlobal.nama + ', Selamat Datang'
        });

      } else { 
        // Alert Gagal tetap muncul di tengah tapi kita perkecil ukurannya
        Swal.fire({ 
          icon: 'error', 
          title: 'Login Gagal', 
          text: 'Username/Password salah!',
          confirmButtonColor: '#4361ee',
          width: '300px' // Kita kunci lebarnya biar mungil
        });
      }
    });

    function setupTombol(info) {
      // Sembunyikan semua elemen dashboard dulu
      document.getElementById('btnMasuk').classList.add('hidden');
      document.getElementById('btnPulang').classList.add('hidden');
      document.getElementById('msgSelesai').classList.add('hidden');
      
      var infoDiv = document.getElementById('infoStatus');
      var tgl = info.tanggal || "Hari Ini";

      // LOGIKA BARU: Prioritaskan status data yang ada di database
      if (!info.adaData) {
    infoDiv.innerHTML = `<div class="fw-bold text-primary">${tgl}</div><small>Silakan Absen Masuk</small>`;
    document.getElementById('btnMasuk').classList.remove('hidden');
} 
      else if (info.adaData && !info.sudahPulang) {
        // Paksa tombol pulang muncul jika data masuk terdeteksi
        infoDiv.innerHTML = `<div class="fw-bold text-success">${tgl}</div><small>Sudah Masuk: <b>${info.jamMasuk}</b></small>`;
        document.getElementById('btnPulang').classList.remove('hidden');
      } 
      else if (info.adaData && info.sudahPulang) {
        infoDiv.innerHTML = `<div class="fw-bold text-dark">${tgl}</div><small>IN: ${info.jamMasuk} | OUT: ${info.jamPulang}</small>`;
        document.getElementById('msgSelesai').classList.remove('hidden');
      }
      else {
        infoDiv.innerHTML = `<div class="fw-bold text-warning">${tgl}</div><small>Status: ${info.status}</small>`;
      }
    }

    // ABSENSI
    function cekAksiAbsen(jenis) {
        if (jarakGlobal > MAX_JARAK_METER) { 
            Swal.fire({ icon: 'error', title: 'Terlalu Jauh', text: 'Anda ' + jarakGlobal + 'm dari kantor. Harap mendekat!' });
            return; 
        }
        if (jenis === 'Masuk') bukaKamera();
        else if (jenis === 'Pulang') {
            Swal.fire({
                title: 'Absen Pulang?', text: "Pastikan pekerjaan Anda sudah selesai.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Pulang'
            }).then((result) => { if (result.isConfirmed) kirimAbsenPulang(); });
        }
    }
    async function kirimAbsenPulang() {
        var res = await kirimKeServer({ action: 'absen', nama: userGlobal.nama, jenisAbsen: 'Pulang', lokasi: lokasiGlobal, fotoBase64: "", keterangan: "-" });
        Swal.fire({ icon: res.status=='sukses'?'success':'error', title: res.status=='sukses'?'Berhasil':'Gagal', text: res.message });
        if(res.status == 'sukses') setupTombol(res.absenInfo);
    }
    function bukaKamera() {
      document.getElementById('modalKamera').classList.remove('hidden');
      var v = document.getElementById('video');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => { v.srcObject = s; setTimeout(()=>{document.getElementById('btnJepret').disabled=false;},1500); }).catch(e => { alert(e); tutupKamera(); });
    }
    function tutupKamera() { var v=document.getElementById('video'); if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById('modalKamera').classList.add('hidden'); }
    async function jepretDanKirim() {
      var v=document.getElementById('video'); var c=document.getElementById('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0);
      var foto = c.toDataURL('image/png'); tutupKamera();
      
      // Loading Alert
      Swal.fire({ title: 'Mengirim Data...', didOpen: () => { Swal.showLoading() } });

      var res = await kirimKeServer({ action: 'absen', nama: userGlobal.nama, jenisAbsen: 'Masuk', lokasi: lokasiGlobal, fotoBase64: foto, keterangan: "-" });
      
      Swal.fire({ icon: res.status=='sukses'?'success':'error', title: res.status=='sukses'?'Berhasil':'Gagal', text: res.message });
      if(res.status == 'sukses') setupTombol(res.absenInfo);
    }

    // MANAJEMEN USER
    async function loadUsers() {
        document.getElementById('listUsers').innerHTML = "<div class='text-center p-3'>Loading...</div>";
        var res = await kirimKeServer({ action: 'get_users' });
        if(res.status == 'sukses') {
            var html = "";
            res.data.forEach(u => {
                // HTML BARU YANG RAPI
                html += `
                <div class="user-item">
                    <div class="user-info">
                        <div>${u.nama}</div>
                        <small>${u.kantor} <span class="badge bg-light text-dark border ms-1">${u.role}</span></small>
                    </div>
                    <div class="user-actions">
                        <button onclick="editUser('${u.username}','${u.password}','${u.nama}','${u.role}','${u.kantor}')" class="btn btn-sm btn-primary-soft shadow-sm" style="width:35px; height:35px; border-radius:8px; padding:0; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-pen" style="font-size:0.8rem"></i>
                        </button>
                        <button onclick="delUser('${u.username}')" class="btn btn-sm btn-outline-danger shadow-sm" style="width:35px; height:35px; border-radius:8px; padding:0; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-trash" style="font-size:0.8rem"></i>
                        </button>
                    </div>
                </div>`;
            });
            document.getElementById('listUsers').innerHTML = html;
        }
    }
    function formUser(mode) {
        document.getElementById('modalFormUser').classList.remove('hidden'); document.getElementById('u_mode').value = mode;
        if(mode == 'add') { document.getElementById('titleFormUser').innerText = "Tambah User"; document.getElementById('u_username').value = ""; document.getElementById('u_password').value = ""; document.getElementById('u_nama').value = ""; }
    }
    function editUser(u,p,n,r,k) {
        formUser('edit'); document.getElementById('titleFormUser').innerText = "Edit User"; document.getElementById('u_old_user').value = u;
        document.getElementById('u_username').value = u; document.getElementById('u_password').value = p; document.getElementById('u_nama').value = n; document.getElementById('u_role').value = r; document.getElementById('u_kantor').value = k;
    }
    function closeFormUser() { document.getElementById('modalFormUser').classList.add('hidden'); }
    async function simpanUser() {
        var mode = document.getElementById('u_mode').value;
        var pl = { action: 'save_user', mode: mode, oldUsername: document.getElementById('u_old_user').value, username: document.getElementById('u_username').value, password: document.getElementById('u_password').value, nama: document.getElementById('u_nama').value, role: document.getElementById('u_role').value, kantor: document.getElementById('u_kantor').value };
        
        Swal.fire({ title: 'Menyimpan...', didOpen: () => { Swal.showLoading() } });
        var res = await kirimKeServer(pl); 
        Swal.fire(res.status=='sukses'?'Berhasil':'Gagal', res.message, res.status=='sukses'?'success':'error');
        if(res.status=='sukses') { closeFormUser(); loadUsers(); }
    }
    async function delUser(u) { 
        Swal.fire({
            title: 'Hapus User?', text: "User " + u + " akan dihapus permanen.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then(async (result) => {
            if (result.isConfirmed) {
                var res = await kirimKeServer({ action: 'del_user', username: u }); 
                Swal.fire('Terhapus!', res.message, 'success');
                if(res.status=='sukses') loadUsers();
            }
        });
    }

    // UTILS
    function bukaOwnerPanel() { document.getElementById('modalOwner').classList.remove('hidden'); loadApproval(); }
    async function loadApproval() {
        var res = await kirimKeServer({ action: 'get_approval' }); var html = "";
        if(res.status == 'sukses' && res.data.length > 0) {
            res.data.forEach(r => {
               var btnBukti = r.bukti ? `<a href="${r.bukti}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mb-2">Lihat Bukti Sakit</a>` : "";
               html += `<div class="card-glass p-3 mb-2 border-start border-4 border-warning"><div class="d-flex justify-content-between mb-1"><span class="fw-bold">${r.nama}</span><small>${r.tanggal}</small></div><div class="small mb-2 text-muted">${r.tipe}: "${r.ket}"</div>${btnBukti}<div class="d-flex gap-2"><button onclick="prosesApprove('${r.id}','Disetujui')" class="btn btn-sm btn-success w-100">Setujui</button><button onclick="prosesApprove('${r.id}','Ditolak')" class="btn btn-sm btn-outline-danger w-100">Tolak</button></div></div>`;
            });
            document.getElementById('listApproval').innerHTML = html;
        } else { document.getElementById('listApproval').innerHTML = "<div class='text-center mt-5 text-muted'>Tidak ada data.</div>"; }
    }
    async function prosesApprove(id, sts) { if(confirm("Ubah status?")) { var res = await kirimKeServer({ action: 'set_approval', id: id, status: sts }); alert(res.message); loadApproval(); } }
    async function loadRekap() {
        var bln = document.getElementById('filterBulan').value; var thn = document.getElementById('filterTahun').value; var cab = document.getElementById('filterCabang').value;
        document.getElementById('hasilRekap').innerHTML = "<div class='text-center'>Loading...</div>";
        var res = await kirimKeServer({ action: 'get_rekap', bulan: bln, tahun: thn, cabang: cab }); var html = "";
        if(res.status == 'sukses' && res.data.length > 0) {
            res.data.forEach(r => { var warna = r.status == 'Hadir' ? 'text-success' : 'text-warning'; html += `<div class="card-glass p-2 mb-2 d-flex justify-content-between align-items-center"><div><div class="fw-bold small">${r.nama}</div><div class="text-muted" style="font-size:0.7rem">${r.tanggal}</div></div><div class="text-end"><div class="fw-bold small ${warna}">${r.status}</div><div style="font-size:0.7rem">In:${r.masuk} Out:${r.pulang}</div></div></div>`; });
            document.getElementById('hasilRekap').innerHTML = html;
        } else { document.getElementById('hasilRekap').innerHTML = "<div class='text-center mt-3 text-muted'>Data kosong.</div>"; }
    }
    function tampilFormIzin() { document.getElementById('modalIzin').classList.remove('hidden'); cekTipeIzin(); }
    function cekTipeIzin() { document.getElementById('boxBuktiSakit').classList.toggle('hidden', document.getElementById('tipeIzin').value !== 'Sakit'); }
    async function kirimIzin() {
        var ket = document.getElementById('ketIzin').value; var tipe = document.getElementById('tipeIzin').value;
        if(!ket) { Swal.fire('Peringatan', 'Mohon isi alasan izin/sakit', 'warning'); return; }
        
        var fileSakitBase64 = "";
        if(tipe === 'Sakit') { var fileInput = document.getElementById('fileSakit'); if(fileInput.files.length > 0) { const toBase64 = f => new Promise((r, j) => { const rd = new FileReader(); rd.readAsDataURL(f); rd.onload=()=>r(rd.result); rd.onerror=e=>j(e); }); fileSakitBase64 = await toBase64(fileInput.files[0]); } }
        
        document.getElementById('modalIzin').classList.add('hidden');
        Swal.fire({ title: 'Mengirim Pengajuan...', didOpen: () => { Swal.showLoading() } });

        var res = await kirimKeServer({ action: 'absen', nama: userGlobal.nama, jenisAbsen: tipe, lokasi: lokasiGlobal, fotoBase64: "", keterangan: ket, buktiSakitBase64: fileSakitBase64 });
        
        Swal.fire({ icon: res.status=='sukses'?'success':'error', title: res.message });
        if(res.status == 'sukses') setupTombol(res.absenInfo);
    }
    function startGPS() { if(navigator.geolocation) gpsId = navigator.geolocation.watchPosition(p=>{ var d=Math.round(hitungJarak(targetLat,targetLon,p.coords.latitude,p.coords.longitude)); document.getElementById('statusJarak').innerHTML = d<=MAX_JARAK_METER ? `<span class="text-success">${d}m OK</span>` : `<span class="text-danger">${d}m Jauh</span>`; jarakGlobal=d; lokasiGlobal=p.coords.latitude+","+p.coords.longitude; }, e=>{}); }
    function hitungJarak(lat1,lon1,lat2,lon2){ if(lat1==0)return 0; var R=6371e3, p=Math.PI/180; var a=0.5-Math.cos((lat2-lat1)*p)/2+Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2; return R*2*Math.asin(Math.sqrt(a)); }
    async function bukaRiwayat() { document.getElementById('modalRiwayat').classList.remove('hidden'); var res=await kirimKeServer({action:'riwayat',nama:userGlobal.nama}); var h=""; res.data.forEach(r=>{ h+=`<div class="card-glass p-2 mb-2"><div class="d-flex justify-content-between"><span class="fw-bold small">${r.tanggal}</span><span class="badge bg-light text-dark border">${r.status}</span></div></div>`; }); document.getElementById('listRiwayat').innerHTML=h; }
    function logout() { if(gpsId) navigator.geolocation.clearWatch(gpsId); userGlobal={}; document.getElementById('formLogin').reset(); document.getElementById('dashboard').classList.add('hidden'); document.getElementById('loginPage').classList.remove('hidden'); }
  </script>
</body>
</html>



