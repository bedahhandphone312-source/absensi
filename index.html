<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Absensi Pro Modern</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #4f46e5, #06b6d4); /* Warna Biru Ungu Modern */
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Poppins', sans-serif; /* Font Modern */
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* CONTAINER HP */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-color);
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 50px rgba(0,0,0,0.1);
    }

    /* HEADER GRADASI */
    .header {
      background: var(--primary-gradient);
      color: white;
      padding: 50px 30px 60px 30px;
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      text-align: center;
      position: relative;
      box-shadow: 0 15px 30px rgba(79, 70, 229, 0.3);
    }
    
    /* CARD STYLE (KARTU MELAYANG) */
    .card-custom {
      background: var(--card-bg);
      border-radius: 25px;
      border: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08); /* Shadow halus */
      padding: 30px;
      margin-bottom: 25px;
      position: relative;
    }

    /* INPUT FORM BULAT */
    .form-control {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 15px;
      padding: 18px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .form-control:focus {
      background: #fff; border-color: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* TOMBOL GRADASI KEREN */
    .btn-grad {
      background: var(--primary-gradient);
      border: none; color: white; border-radius: 18px;
      padding: 18px; font-weight: 600; letter-spacing: 0.5px;
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
      transition: transform 0.2s;
    }
    .btn-grad:active { transform: scale(0.98); }
    
    .btn-masuk { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4); }
    .btn-pulang { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }

    /* STATUS BOX */
    .status-box {
      border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px;
    }

    /* KAMERA FULLSCREEN */
    #modalKamera { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #video { width: 100%; height: 100%; object-fit: cover; position: absolute; transform: scaleX(-1); }
    .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.85) 80%); pointer-events: none; }
    .face-frame { 
      position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
      width: 280px; height: 380px; border: 3px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
      box-shadow: 0 0 60px rgba(6, 182, 212, 0.4);
    }
    .scan-line {
      width: 100%; height: 4px; background: #06b6d4; position: absolute; top: 0;
      animation: scanning 2s ease-in-out infinite; box-shadow: 0 0 20px #06b6d4;
    }
    @keyframes scanning { 0%, 100% {top: 0; opacity: 0;} 50% {top: 100%; opacity: 1;} }
    .camera-controls { position: absolute; bottom: 50px; width: 100%; text-align: center; z-index: 20; }
    
    /* UTILITIES */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    #loadingOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(255,255,255,0.9); z-index: 10000; 
      display:flex; justify-content:center; align-items:center; flex-direction:column;
    }
    .spinner-custom { width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="hidden">
    <div class="spinner-custom"></div>
    <div class="mt-4 fw-bold text-dark" style="letter-spacing: 2px;">MEMPROSES...</div>
  </div>

  <div class="app-container">
    
    <div id="loginPage" class="fade-in">
      <div class="header">
        <div class="mb-4"><i class="fas fa-fingerprint fa-4x text-white-50"></i></div>
        <h2 class="fw-bold">Absensi Pro</h2>
        <p class="opacity-75">Sistem Absensi Karyawan</p>
      </div>
      
      <div class="content" style="margin-top: -50px;">
        <div class="card-custom">
          <form id="formLogin">
            <div class="mb-3">
              <label class="text-muted small ms-2 mb-1">Username</label>
              <input type="text" id="username" class="form-control" placeholder="Isi username..." required>
            </div>
            <div class="mb-4">
              <label class="text-muted small ms-2 mb-1">Password</label>
              <input type="password" id="password" class="form-control" placeholder="Isi password..." required>
            </div>
            <button type="submit" class="btn btn-grad w-100 fs-5">MASUK SISTEM</button>
          </form>
        </div>
        <div class="text-center text-muted small mt-3">Ver 2.5 Modern UI</div>
      </div>
    </div>

    <div id="dashboard" class="hidden fade-in">
      <div class="header pb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
           <small class="opacity-75 bg-white bg-opacity-25 px-3 py-1 rounded-pill">Halo, Selamat Datang</small>
           <div onclick="logout()" style="cursor:pointer;" class="text-white"><i class="fas fa-sign-out-alt"></i></div>
        </div>
        <h2 id="userNama" class="fw-bold mb-1">Nama User</h2>
        <div class="d-inline-block bg-white bg-opacity-20 px-3 py-1 rounded-pill mt-2">
            <i class="fas fa-map-marker-alt me-1"></i> <span id="userKantor">-</span>
        </div>
      </div>

      <div class="content" style="margin-top: -60px;">
        
        <div class="card-custom text-center py-3 px-3 mb-3">
           <div id="statusJarak" class="fw-bold text-muted small">
             <i class="fas fa-satellite-dish fa-spin me-2"></i>Mencari Lokasi...
           </div>
        </div>

        <div id="infoStatus" class="status-box shadow-sm">
          Memuat data...
        </div>
        
        <div id="actionButtons">
          <button id="btnMasuk" onclick="cekAksiAbsen('Masuk')" class="btn btn-grad btn-masuk w-100 mb-3 hidden">
            <div class="d-flex align-items-center justify-content-center py-1">
              <i class="fas fa-camera fa-2x me-3"></i> 
              <div class="text-start">
                  <div style="font-size: 0.8rem; opacity: 0.9;">Klik Untuk</div>
                  <div class="fs-5">ABSEN MASUK</div>
              </div>
            </div>
          </button>
          
          <button id="btnPulang" onclick="cekAksiAbsen('Pulang')" class="btn btn-grad btn-pulang w-100 mb-3 hidden">
            <div class="d-flex align-items-center justify-content-center py-1">
               <i class="fas fa-home fa-2x me-3"></i>
               <div class="text-start">
                  <div style="font-size: 0.8rem; opacity: 0.9;">Klik Untuk</div>
                  <div class="fs-5">ABSEN PULANG</div>
              </div>
            </div>
          </button>
          
          <div id="msgSelesai" class="alert alert-success text-center hidden p-4" style="border-radius: 20px;">
            <i class="fas fa-check-circle fa-4x mb-3 text-success"></i><br>
            <span class="fw-bold fs-5">Absensi Selesai!</span><br>
            <small>Terima kasih sudah bekerja hari ini.</small>
          </div>
        </div>
        
        <div class="row g-3 mt-1">
          <div class="col-6">
            <div class="card-custom p-3 text-center h-100" onclick="bukaRiwayat()" style="cursor:pointer; margin-bottom:0; display:flex; flex-direction:column; align-items:center; justify-content:center;">
              <div class="bg-primary bg-opacity-10 p-3 rounded-circle mb-2 text-primary">
                  <i class="fas fa-history fa-lg"></i>
              </div>
              <div class="fw-bold small">Riwayat</div>
            </div>
          </div>
          <div class="col-6">
             <div class="card-custom p-3 text-center h-100" onclick="tampilFormIzin()" style="cursor:pointer; margin-bottom:0; display:flex; flex-direction:column; align-items:center; justify-content:center;">
              <div class="bg-warning bg-opacity-10 p-3 rounded-circle mb-2 text-warning">
                  <i class="fas fa-file-medical fa-lg"></i>
              </div>
              <div class="fw-bold small">Izin / Sakit</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="modalKamera" class="hidden fade-in">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" class="hidden"></canvas>
      
      <div class="scan-overlay"></div>
      <div class="face-frame">
        <div class="scan-line" id="scanLine"></div>
      </div>

      <div class="camera-controls">
        <div id="textSensor" class="text-white bg-dark bg-opacity-50 px-4 py-2 rounded-pill mb-4 small" style="letter-spacing: 2px;">MENGHUBUNGKAN...</div>
        
        <button id="btnJepret" onclick="jepretDanKirim()" class="btn btn-light btn-lg w-100 fw-bold shadow-lg rounded-pill py-3 text-primary" disabled>
          <i class="fas fa-camera me-2"></i> AMBIL FOTO
        </button>
        
        <button onclick="tutupKamera()" class="btn btn-outline-light btn-sm mt-4 px-5 rounded-pill">Batal</button>
      </div>
    </div>
    
    <div id="modalIzin" class="hidden fade-in" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div class="card-custom w-100" style="max-width:400px; position:relative;">
        <button onclick="document.getElementById('modalIzin').classList.add('hidden')" class="btn-close position-absolute top-0 end-0 m-4"></button>
        <h4 class="fw-bold mb-4 text-center">Form Pengajuan</h4>
        <select id="tipeIzin" class="form-select mb-3"><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Cuti">Cuti</option></select>
        <textarea id="ketIzin" class="form-control mb-4" rows="3" placeholder="Tulis alasan..."></textarea>
        <button onclick="kirimIzin()" class="btn btn-warning w-100 fw-bold py-3 text-white rounded-4">KIRIM PENGAJUAN</button>
      </div>
    </div>

    <div id="modalRiwayat" class="hidden fade-in" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f3f4f6;z-index:100;overflow-y:auto;">
      <div class="header py-4 px-3 d-flex justify-content-between align-items-center mb-2" style="border-radius:0 0 30px 30px;">
        <h4 class="mb-0">Riwayat Absensi</h4>
        <button onclick="document.getElementById('modalRiwayat').classList.add('hidden')" class="btn btn-sm btn-light rounded-circle p-2"><i class="fas fa-times"></i></button>
      </div>
      <div id="listRiwayat" class="content">Loading...</div>
    </div>

  </div>

  <script>
    // ==========================================
    // PASTE URL DEPLOYMENT GOOGLE SCRIPT DISINI
    // ==========================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDn9JuLWlKotsGtmMIpLnzv0CU7Mzio6OvndHtLA-Ru9SxTYk3dRCV6zGFUJGMLVE/exec"; 
    // ==========================================

    const DAFTAR_KANTOR = [
      { nama: "Cabang Aimas 1", lat: -0.9428240, lon: 131.3272016 },
      { nama: "Cabang Aimas 2", lat: 0.000000, lon: 0.000000 },
      { nama: "Cabang KM 12",   lat: 0.000000, lon: 0.000000 },
      { nama: "Cabang KM 13",   lat: 0.000000, lon: 0.000000 }
    ];
    const MAX_JARAK_METER = 50; 

    var userGlobal = {}, lokasiGlobal = "", jarakGlobal = 9999, targetLat=0, targetLon=0, tipeAbsenAktif = "";

    async function kirimKeServer(payload) {
      document.getElementById('loadingOverlay').classList.remove('hidden');
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST', body: JSON.stringify(payload)
        });
        const hasil = await response.json();
        document.getElementById('loadingOverlay').classList.add('hidden');
        return hasil;
      } catch (error) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        alert("Gagal koneksi: " + error); return null;
      }
    }

    // 1. LOGIN
    document.getElementById('formLogin').addEventListener('submit', async function(e){
      e.preventDefault();
      var u = document.getElementById('username').value;
      var p = document.getElementById('password').value;
      var res = await kirimKeServer({ action: 'login', username: u, password: p });
      if(res && res.status == 'sukses'){
        userGlobal = res.data;
        document.getElementById('userNama').innerText = userGlobal.nama;
        document.getElementById('userKantor').innerText = userGlobal.kantorTugas;
        var kantor = DAFTAR_KANTOR.find(k => k.nama === userGlobal.kantorTugas);
        if(kantor) { targetLat = kantor.lat; targetLon = kantor.lon; } 
        else { targetLat = 0; targetLon = 0; }

        setupTombol(res.absenInfo);
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        startGPS();
      } else { alert("Login Gagal: " + (res ? "Cek User/Pass" : "Server Error")); }
    });

    // UPDATE UI (WARNA WARNI MODERN)
    function setupTombol(info) {
      document.getElementById('btnMasuk').classList.add('hidden');
      document.getElementById('btnPulang').classList.add('hidden');
      document.getElementById('msgSelesai').classList.add('hidden');
      var infoDiv = document.getElementById('infoStatus');
      var tglHariIni = info.tanggal || "Hari Ini";

      if (!info.sudahMasuk) {
        // BELUM ABSEN
        infoDiv.innerHTML = `
            <div class="fw-bold text-primary mb-2 fs-5">${tglHariIni}</div>
            <div class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">Status: Belum Absen</div>
        `;
        infoDiv.style.background = "#eef2ff"; 
        document.getElementById('btnMasuk').classList.remove('hidden');

      } else if (info.sudahMasuk && !info.sudahPulang) {
        // SUDAH MASUK
        infoDiv.innerHTML = `
            <div class="fw-bold text-success mb-2 fs-5">${tglHariIni}</div>
            <div class="d-flex justify-content-center gap-4">
                <div class="text-center"><div class="small text-muted">MASUK</div><div class="fw-bold fs-5">${info.jamMasuk}</div></div>
                <div class="text-center opacity-50"><div class="small text-muted">PULANG</div><div class="fw-bold fs-5">-</div></div>
            </div>
        `;
        infoDiv.style.background = "#f0fdf4"; 
        document.getElementById('btnPulang').classList.remove('hidden');

      } else {
        // SELESAI
        infoDiv.innerHTML = `
            <div class="fw-bold text-secondary mb-2 fs-5">${tglHariIni}</div>
            <div class="d-flex justify-content-center gap-4">
                <div class="text-center"><div class="small text-muted">MASUK</div><div class="fw-bold fs-5">${info.jamMasuk}</div></div>
                <div class="text-center"><div class="small text-muted">PULANG</div><div class="fw-bold fs-5">${info.jamPulang}</div></div>
            </div>
        `;
        infoDiv.style.background = "#f9fafb";
        document.getElementById('msgSelesai').classList.remove('hidden');
      }
    }

    // 2. LOGIKA TOMBOL (PULANG = CONFIRM, MASUK = KAMERA)
    function cekAksiAbsen(jenis) {
        if (jarakGlobal > MAX_JARAK_METER) { 
            alert("âŒ Posisi Anda terlalu jauh ("+jarakGlobal+"m) dari kantor!"); return; 
        }
        tipeAbsenAktif = jenis;
        if (jenis === 'Masuk') {
            bukaKamera(); 
        } else if (jenis === 'Pulang') {
            if(confirm("Apakah Anda yakin ingin Absen Pulang sekarang?")) { kirimAbsenPulang(); }
        }
    }

    async function kirimAbsenPulang() {
        var res = await kirimKeServer({
            action: 'absen', nama: userGlobal.nama, jenisAbsen: 'Pulang',
            lokasi: lokasiGlobal + " (" + userGlobal.kantorTugas + ")", fotoBase64: "", keterangan: "-"
        });
        alert(res.message);
        if(res.status == 'sukses') setupTombol(res.absenInfo);
    }

    // 3. KAMERA
    function bukaKamera() {
      document.getElementById('modalKamera').classList.remove('hidden');
      var video = document.getElementById('video');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
        video.srcObject = s; simulasiSensor();
      }).catch(e => { alert("Error Kamera: "+e); tutupKamera(); });
    }

    function simulasiSensor() {
      var txt = document.getElementById('textSensor');
      var line = document.getElementById('scanLine');
      var btn = document.getElementById('btnJepret');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> SCANNING...';
      txt.innerText = "MENCARI WAJAH..."; line.style.display = "block";
      setTimeout(function(){
        txt.innerText = "WAJAH TERDETEKSI"; txt.style.color="#4ade80"; line.style.display = "none"; 
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-camera me-2"></i> JEPRET';
      }, 1500);
    }

    function tutupKamera() {
      var v = document.getElementById('video'); if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
      document.getElementById('modalKamera').classList.add('hidden');
    }

    async function jepretDanKirim() {
      var v = document.getElementById('video'); var c = document.getElementById('canvas');
      c.width = v.videoWidth; c.height = v.videoHeight;
      c.getContext('2d').drawImage(v, 0, 0);
      var foto = c.toDataURL('image/png');
      tutupKamera(); 
      var res = await kirimKeServer({
        action: 'absen', nama: userGlobal.nama, jenisAbsen: 'Masuk',
        lokasi: lokasiGlobal + " (" + userGlobal.kantorTugas + ")", fotoBase64: foto, keterangan: "-"
      });
      alert(res.message); 
      if(res.status == 'sukses') setupTombol(res.absenInfo);
    }

    // 4. GPS
    function startGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(p => {
          var lat = p.coords.latitude, lon = p.coords.longitude;
          lokasiGlobal = lat + "," + lon;
          jarakGlobal = Math.round(hitungJarak(targetLat, targetLon, lat, lon));
          var div = document.getElementById('statusJarak');
          if(jarakGlobal <= MAX_JARAK_METER) {
             div.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i> Lokasi Valid (${jarakGlobal}m)</span>`;
          } else {
             div.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i> Kejauhan (${jarakGlobal}m)</span>`;
          }
        }, e => document.getElementById('statusJarak').innerText = "GPS Error", {enableHighAccuracy:true});
      }
    }
    function hitungJarak(lat1, lon1, lat2, lon2) {
      if(lat1 == 0) return 0;
      var R = 6371e3, p = Math.PI/180;
      var a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p) * (1-Math.cos((lon2-lon1)*p))/2;
      return R * 2 * Math.asin(Math.sqrt(a));
    }

    function tampilFormIzin() { document.getElementById('modalIzin').classList.remove('hidden'); }
    async function kirimIzin() {
      var ket = document.getElementById('ketIzin').value;
      if(!ket) { alert("Isi alasan!"); return; }
      document.getElementById('modalIzin').classList.add('hidden');
      var res = await kirimKeServer({
        action: 'absen', nama: userGlobal.nama, jenisAbsen: document.getElementById('tipeIzin').value,
        lokasi: lokasiGlobal, fotoBase64: "", keterangan: ket
      });
      alert(res.message); if(res.status == 'sukses') setupTombol(res.absenInfo);
    }

    async function bukaRiwayat() {
      document.getElementById('modalRiwayat').classList.remove('hidden');
      var res = await kirimKeServer({ action: 'riwayat', nama: userGlobal.nama });
      var div = document.getElementById('listRiwayat');
      if(res.status == 'sukses' && res.data.length > 0) {
        var html = "";
        res.data.forEach(r => {
           let warna = r.status == 'Hadir' ? 'border-success' : 'border-warning';
           let icon = r.status == 'Hadir' ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-clock text-warning"></i>';
           html += `
            <div class="card-custom p-3 mb-3 border-start border-4 ${warna} shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-dark">${r.tanggal}</span>
                <span class="badge bg-light text-dark border">${icon} ${r.status}</span>
              </div>
              <div class="small text-muted d-flex justify-content-between px-2">
                 <span><i class="fas fa-sign-in-alt me-1"></i> ${r.masuk}</span>
                 <span><i class="fas fa-sign-out-alt me-1"></i> ${r.pulang}</span>
              </div>
            </div>`;
        });
        div.innerHTML = html;
      } else { div.innerHTML = "<div class='text-center mt-5 text-muted'>Belum ada riwayat.</div>"; }
    }

    function logout() { location.reload(); }
  </script>
</body>
</html>
